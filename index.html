<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>가게 프로토타입</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#101f36;
      --btn:#1b2a46;
      --btn2:#23385e;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22c55e;
      --danger:#ef4444;
      --line:rgba(255,255,255,.12);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{ box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif; }
    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(1200px 800px at 30% 20%, rgba(34,197,94,.18), transparent 55%),
                  radial-gradient(1000px 700px at 70% 80%, rgba(59,130,246,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }

    /* 홈 */
    .screen{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
      position:relative;
    }
    .center-actions{
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
      justify-content:center;
      width:min(520px, 92vw);
      padding:28px;
      background: rgba(15,26,46,.72);
      border:1px solid var(--line);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .title{
      font-size:20px;
      font-weight:900;
      letter-spacing:-0.02em;
      margin:0 0 6px 0;
    }
    .subtitle{
      margin:0 0 12px 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
      text-align:center;
    }
    .btn{
      width:100%;
      border:0;
      border-radius:14px;
      padding:14px 16px;
      font-size:15px;
      font-weight:900;
      color:var(--text);
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      border:1px solid var(--line);
      cursor:pointer;
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn-primary{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.9));
      color:#05210f;
      border: 1px solid rgba(5,150,105,.35);
    }
    .btn-disabled{
      opacity:.45;
      filter:saturate(.7);
      cursor:not-allowed;
      pointer-events:none;
    }
    .bottom-left{
      position:absolute;
      left:24px;
      bottom:24px;
      display:flex;
      flex-direction:column;
      gap:10px;
      width:min(220px, 44vw);
    }
    .bottom-right{
      position:absolute;
      right:24px;
      bottom:24px;
      width:min(220px, 44vw);
      display:flex;
      justify-content:flex-end;
    }
    @media (max-width: 520px){
      .bottom-left{ left:16px; bottom:16px; width:44vw; }
      .bottom-right{ right:16px; bottom:16px; width:44vw; }
      .center-actions{ padding:22px; }
    }

    /* 오버레이/모달 */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.55);
      padding:24px;
      z-index:50;
    }
    .overlay.is-open{ display:grid; }

    .modal{
      width:min(980px, 96vw);
      background: rgba(15,26,46,.92);
      border:1px solid var(--line);
      border-radius: calc(var(--radius) + 10px);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(10px);
      position:relative;
    }

    /* 재료 세팅 UI 레이아웃 */
    .setup-wrap{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .setup-wrap{ grid-template-columns: 1fr; }
    }

    .panel{
      background: rgba(16,31,54,.9);
      border:1px solid var(--line);
      border-radius: 18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      min-height:520px;
      min-width:0;
    }
    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .panel-title{
      font-weight:900;
      letter-spacing:-0.02em;
      font-size:15px;
      margin:0;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
      margin:0;
    }

    /* 좌측: 레시피 */
    .bread-row{
      display:flex;
      gap:10px;
      align-items:stretch;
      margin-bottom:10px;
    }
    .bread-btn{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(27,42,70,.65);
      cursor:pointer;
      user-select:none;
      font-weight:900;
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      white-space:nowrap;
    }

    .dropdown{ position:relative; flex:1; min-width:0; }
    .dropdown-menu{
      position:absolute;
      left:0; right:0;
      top:calc(100% + 8px);
      background: rgba(15,26,46,.98);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow: var(--shadow);
      display:none;
      z-index:60;
      max-height:240px;
      overflow:auto;
    }
    .dropdown.open .dropdown-menu{ display:block; }
    .dd-item{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:800;
    }
    .dd-item:last-child{ border-bottom:0; }
    .dd-item:hover{ background: rgba(255,255,255,.06); }

    .recipe-box{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      padding:10px;
      flex:1;
      min-height:320px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .recipe-slot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .slot-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .slot-idx{
      width:22px;
      height:22px;
      border-radius:999px;
      display:grid;
      place-items:center;
      font-size:12px;
      font-weight:900;
      color:#062314;
      background: rgba(34,197,94,.9);
      flex:0 0 auto;
    }
    .slot-name{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .slot-cat{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .slot-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .mini-btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
    }
    .mini-btn:active{ transform: translateY(1px); }
    .mini-btn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.14);
    }
    .drop-hint{
      margin-top:auto;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* 우측: 분류 탭 + 재료 리스트 */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      user-select:none;
    }
    .tab.active{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.35);
      color: rgba(215,255,228,.95);
    }

    .items{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }
    .items-scroll{
      overflow:auto;
      padding:10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 900px){
      .items-scroll{ grid-template-columns: 1fr; }
    }
    .item{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(27,42,70,.45);
      border-radius:14px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:grab;
      user-select:none;
      min-width:0;
    }
    .item:active{ cursor:grabbing; }
    .item.disabled{
      opacity:.40;
      cursor:not-allowed;
      filter:saturate(.6);
    }
    .item-left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .item-name{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item-sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .count{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      flex:0 0 auto;
    }

    /* 하단 버튼바 */
    .modal-footer{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .btn-flat{
      width:100%;
      border-radius:16px;
      padding:14px 16px;
      font-size:15px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
    }
    .btn-flat.primary{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.35);
    }
    .btn-flat.danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
    }

    /* 드롭 가능 상태 표시 */
    .droppable{
      outline: 2px solid rgba(34,197,94,.35);
      outline-offset: 2px;
    }

    /***********************
     * 프리셋(=미리보기) 팝업
     ***********************/
    .preview-overlay{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.62);
      padding:24px;
      z-index:80; /* 가게 운영 팝업 위 */
    }
    .preview-overlay.is-open{ display:grid; }

    .preview-modal{
      width:min(720px, 96vw);
      border-radius: calc(var(--radius) + 10px);
      border:1px solid var(--line);
      background: rgba(15,26,46,.95);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .preview-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .preview-title{
      font-weight:900;
      letter-spacing:-0.02em;
      font-size:15px;
      margin:0;
    }
    .preview-sub{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }
    .preview-grid{
      display:grid;
      grid-template-columns: 1fr 260px;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 720px){
      .preview-grid{ grid-template-columns: 1fr; }
    }
    .burger-stage{
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background: rgba(255,255,255,.03);
      padding:14px;
      min-height:420px;
      display:grid;
      place-items:center;
    }
    .burger{
      width:min(360px, 90%);
      display:flex;
      flex-direction:column;
      align-items:stretch;
      gap:6px;
      padding:10px;
    }
    .layer{
      height:34px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
      letter-spacing:-0.01em;
      user-select:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:0 10px;
    }
    .layer.bun-top{ height:46px; border-radius: 24px 24px 16px 16px; }
    .layer.bun-bot{ height:42px; border-radius: 16px 16px 24px 24px; }

    /* 카테고리별 레이어 스타일(외형 느낌) */
    .layer.meat{ background: rgba(244,63,94,.16); }
    .layer.veg{ background: rgba(34,197,94,.16); }
    .layer.spice{ background: rgba(168,85,247,.16); }
    .layer.bread{ background: rgba(245,158,11,.16); }

    .preview-side{
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background: rgba(255,255,255,.03);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:420px;
    }
    .meta-box{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(27,42,70,.35);
      border-radius:14px;
      padding:10px;
    }
    .meta-title{
      font-weight:900;
      font-size:12px;
      margin:0 0 6px 0;
      color: rgba(255,255,255,.9);
    }
    .meta-text{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .preview-actions{
      margin-top:auto;
      display:flex;
      gap:10px;
    }
    .preview-actions .btn-flat{ padding:12px 14px; }
  </style>
</head>
<body>
  <!-- 홈 화면 -->
  <main class="screen" id="home">
    <section class="center-actions" aria-label="홈 메뉴">
      <h1 class="title">가게 운영</h1>
      <p class="subtitle">현재 상호작용은 ‘가게 운영 시작’만 가능합니다.</p>
      <button class="btn btn-primary" id="btnStart">가게 운영 시작</button>
    </section>

    <div class="bottom-left" aria-label="좌측 하단 메뉴">
      <button class="btn btn-disabled" aria-disabled="true">가게 연구</button>
      <button class="btn btn-disabled" aria-disabled="true">창고</button>
    </div>

    <div class="bottom-right" aria-label="우측 하단 메뉴">
      <button class="btn btn-disabled" aria-disabled="true">나가기</button>
    </div>
  </main>

  <!-- 가게 운영 시작(재료 세팅) 팝업 -->
  <div class="overlay" id="opStartOverlay" role="dialog" aria-modal="true" aria-labelledby="opStartTitle">
    <div class="modal">
      <div class="panel-header" style="margin-bottom:12px;">
        <div>
          <div class="panel-title" id="opStartTitle">햄버거 재료 세팅</div>
          <p class="hint">우측 재료를 드래그해서 레시피에 넣을 수 있습니다. (최대 10개)</p>
        </div>
        <div class="chip" id="recipeCountChip">0 / 10</div>
      </div>

      <div class="setup-wrap" id="setupView">
        <!-- 좌측: 레시피 -->
        <section class="panel" aria-label="레시피">
          <div class="panel-header">
            <h3 class="panel-title">레시피</h3>
            <span class="chip" id="selectedBreadChip">빵: 밀 빵</span>
          </div>

          <!-- 빵 선택 -->
          <div class="bread-row">
            <div class="dropdown" id="breadDropdown">
              <div class="bread-btn" id="breadBtn" role="button" tabindex="0" aria-label="빵 선택">
                <span>빵 선택</span>
                <span class="chip" id="breadBtnValue">밀 빵</span>
              </div>
              <div class="dropdown-menu" id="breadMenu" aria-label="빵 목록"></div>
            </div>
          </div>

          <!-- 레시피 재료 슬롯 -->
          <div class="recipe-box" id="recipeDropZone" aria-label="레시피 재료 칸 (드롭 가능)">
            <!-- 렌더 -->
          </div>

          <p class="drop-hint">
            • 우측 재료를 드래그하여 추가<br/>
            • 추가된 재료는 제거 버튼으로 다시 뺄 수 있음
          </p>
        </section>

        <!-- 우측: 분류/재료 -->
        <section class="panel" aria-label="재료 목록">
          <div class="panel-header">
            <h3 class="panel-title">재료</h3>
            <p class="hint">보유 수량이 0개인 재료는 비활성 처리됩니다.</p>
          </div>

          <div class="tabs" id="tabs">
            <div class="tab active" data-cat="고기">고기</div>
            <div class="tab" data-cat="채소">채소</div>
            <div class="tab" data-cat="향신료">향신료</div>
          </div>

          <div class="items">
            <div class="items-scroll" id="itemsGrid" aria-label="재료 스크롤 리스트"></div>
          </div>
        </section>
      </div>

      <!-- 하단 버튼 -->
      <div class="modal-footer" aria-label="하단 버튼">
        <button class="btn-flat primary" id="btnPlay">시작</button>
        <button class="btn-flat" id="btnPreset">프리셋</button>
        <button class="btn-flat danger" id="btnExit">나가기</button>
      </div>
    </div>
  </div>

  <!-- 프리셋(=햄버거 외형 미리보기) 팝업 -->
  <div class="preview-overlay" id="previewOverlay" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="preview-modal">
      <div class="preview-head">
        <div>
          <div class="preview-title" id="previewTitle">프리셋 (햄버거 외형 미리보기)</div>
          <p class="preview-sub">재료/빵을 변경하면 이 화면의 외형도 즉시 반영됩니다.</p>
        </div>
        <div class="chip" id="previewCountChip">0 / 10</div>
      </div>

      <div class="preview-grid">
        <div class="burger-stage" aria-label="햄버거 이미지 영역">
          <div class="burger" id="burgerView"></div>
        </div>

        <aside class="preview-side" aria-label="미리보기 정보">
          <div class="meta-box">
            <p class="meta-title">선택 빵</p>
            <p class="meta-text" id="previewBreadText">-</p>
          </div>
          <div class="meta-box">
            <p class="meta-title">재료 순서</p>
            <p class="meta-text" id="previewItemsText">-</p>
          </div>
          <div class="meta-box">
            <p class="meta-title">목적</p>
            <p class="meta-text">영업 중 판매될 햄버거가 어떻게 보이는지 시각적으로 확인</p>
          </div>

          <div class="preview-actions">
            <button class="btn-flat danger" id="btnPreviewExit">나가기</button>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * 데이터(기획서 기반)
     ***********************/
    const BREADS = ["밀 빵","브리오슈","치아바타","베이글","머핀"];

    const INGREDIENTS = [
      // 고기
      { name:"콩고기", cat:"고기", infinite:true },
      { name:"돼지고기", cat:"고기" },
      { name:"소고기", cat:"고기" },
      { name:"닭고기", cat:"고기" },
      { name:"물고기", cat:"고기" },

      // 채소
      { name:"토마토", cat:"채소" },
      { name:"양상추", cat:"채소" },
      { name:"감자", cat:"채소" },
      { name:"당근", cat:"채소" },
      { name:"상추", cat:"채소" },
      { name:"파프리카", cat:"채소" },
      { name:"가지", cat:"채소" },
      { name:"브로콜리", cat:"채소" },
      { name:"콜리플라워", cat:"채소" },
      { name:"청경채", cat:"채소" },
      { name:"아티초크", cat:"채소" },
      { name:"블루베리", cat:"채소" },
      { name:"호박", cat:"채소" },

      // 향신료
      { name:"마늘", cat:"향신료" },
      { name:"고추", cat:"향신료" },
      { name:"깻잎", cat:"향신료" },
      { name:"로즈마리", cat:"향신료" },
      { name:"바질", cat:"향신료" },
      { name:"박하", cat:"향신료" },
      { name:"샬롯", cat:"향신료" },
      { name:"캐모마일", cat:"향신료" },
    ];

    // 보유 수량(프로토타입용 샘플) - 0이면 비활성
    // 콩고기 무한(∞)
    const STOCK = {
      "콩고기": Infinity,
      "돼지고기": 3,
      "소고기": 2,
      "닭고기": 0,
      "물고기": 1,

      "토마토": 5,
      "양상추": 0,
      "감자": 4,
      "당근": 2,
      "상추": 1,
      "파프리카": 0,
      "가지": 2,
      "브로콜리": 1,
      "콜리플라워": 0,
      "청경채": 1,
      "아티초크": 0,
      "블루베리": 2,
      "호박": 3,

      "마늘": 6,
      "고추": 2,
      "깻잎": 1,
      "로즈마리": 0,
      "바질": 2,
      "박하": 0,
      "샬롯": 1,
      "캐모마일": 0,
    };

    /***********************
     * 상태
     ***********************/
    const MAX_RECIPE = 10;
    let selectedBread = "밀 빵";
    let currentTab = "고기";
    let recipeItems = []; // [{name, cat}]

    /***********************
     * 엘리먼트
     ***********************/
    const btnStart = document.getElementById('btnStart');
    const overlay = document.getElementById('opStartOverlay');

    const recipeDropZone = document.getElementById('recipeDropZone');
    const recipeCountChip = document.getElementById('recipeCountChip');

    const selectedBreadChip = document.getElementById('selectedBreadChip');
    const breadDropdown = document.getElementById('breadDropdown');
    const breadBtn = document.getElementById('breadBtn');
    const breadBtnValue = document.getElementById('breadBtnValue');
    const breadMenu = document.getElementById('breadMenu');

    const tabs = document.getElementById('tabs');
    const itemsGrid = document.getElementById('itemsGrid');

    const btnPlay = document.getElementById('btnPlay');
    const btnPreset = document.getElementById('btnPreset');
    const btnExit = document.getElementById('btnExit');

    // 프리셋(미리보기) 팝업
    const previewOverlay = document.getElementById('previewOverlay');
    const btnPreviewExit = document.getElementById('btnPreviewExit');
    const burgerView = document.getElementById('burgerView');
    const previewBreadText = document.getElementById('previewBreadText');
    const previewItemsText = document.getElementById('previewItemsText');
    const previewCountChip = document.getElementById('previewCountChip');

    /***********************
     * 유틸
     ***********************/
    function openOverlay(){
      overlay.classList.add('is-open');
      breadDropdown.classList.remove('open');
      renderAll();
    }
    function closeOverlay(){
      overlay.classList.remove('is-open');
      breadDropdown.classList.remove('open');
      closePreview(); // 운영 팝업 닫힐 때 미리보기도 함께 닫기
      recipeDropZone.classList.remove('droppable');
    }

    function openPreview(){
      previewOverlay.classList.add('is-open');
      renderPreview(); // 오픈 시 1회 렌더
    }
    function closePreview(){
      previewOverlay.classList.remove('is-open');
    }
    function isPreviewOpen(){
      return previewOverlay.classList.contains('is-open');
    }

    function setBread(bread){
      selectedBread = bread;
      selectedBreadChip.textContent = `빵: ${selectedBread}`;
      breadBtnValue.textContent = selectedBread;
      // 미리보기 실시간 반영
      if (isPreviewOpen()) renderPreview();
    }

    function getCountLabel(name){
      const v = STOCK[name];
      if (v === Infinity) return "∞";
      return String(v ?? 0);
    }
    function isAvailable(name){
      const v = STOCK[name];
      return v === Infinity || (typeof v === "number" && v > 0);
    }
    function updateRecipeCount(){
      recipeCountChip.textContent = `${recipeItems.length} / ${MAX_RECIPE}`;
    }

    /***********************
     * 렌더: 빵 드롭다운
     ***********************/
    function renderBreadMenu(){
      breadMenu.innerHTML = "";
      BREADS.forEach(b => {
        const div = document.createElement("div");
        div.className = "dd-item";
        const label = (b === "밀 빵") ? `${b}  (∞)` : b;
        div.textContent = label;
        div.addEventListener("click", () => {
          setBread(b);
          breadDropdown.classList.remove("open");
        });
        breadMenu.appendChild(div);
      });
    }

    /***********************
     * 렌더: 우측 재료 리스트
     ***********************/
    function renderItems(){
      itemsGrid.innerHTML = "";
      const list = INGREDIENTS.filter(x => x.cat === currentTab);

      list.forEach(x => {
        const card = document.createElement("div");
        const available = isAvailable(x.name);

        card.className = "item" + (available ? "" : " disabled");
        card.setAttribute("draggable", available ? "true" : "false");
        card.dataset.name = x.name;
        card.dataset.cat = x.cat;

        const left = document.createElement("div");
        left.className = "item-left";

        const name = document.createElement("div");
        name.className = "item-name";
        name.textContent = x.name;

        const sub = document.createElement("div");
        sub.className = "item-sub";
        sub.textContent = `${x.cat} · 보유 ${getCountLabel(x.name)}`;

        left.appendChild(name);
        left.appendChild(sub);

        const count = document.createElement("div");
        count.className = "count";
        count.textContent = getCountLabel(x.name);

        card.appendChild(left);
        card.appendChild(count);

        if (available){
          card.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", JSON.stringify({
              type: "add",
              name: x.name,
              cat: x.cat
            }));
          });
        }

        itemsGrid.appendChild(card);
      });
    }

    /***********************
     * 렌더: 좌측 레시피 슬롯
     ***********************/
    function renderRecipe(){
      recipeDropZone.innerHTML = "";

      if (recipeItems.length === 0){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.style.padding = "8px 2px";
        empty.textContent = "레시피 재료가 비어있습니다. 우측 재료를 드래그해서 넣어주세요.";
        recipeDropZone.appendChild(empty);
      }

      recipeItems.forEach((it, idx) => {
        const row = document.createElement("div");
        row.className = "recipe-slot";

        const left = document.createElement("div");
        left.className = "slot-left";

        const badge = document.createElement("div");
        badge.className = "slot-idx";
        badge.textContent = String(idx + 1);

        const name = document.createElement("div");
        name.className = "slot-name";
        name.textContent = it.name;

        const cat = document.createElement("div");
        cat.className = "slot-cat";
        cat.textContent = it.cat;

        left.appendChild(badge);
        left.appendChild(name);
        left.appendChild(cat);

        const actions = document.createElement("div");
        actions.className = "slot-actions";

        const removeBtn = document.createElement("button");
        removeBtn.className = "mini-btn danger";
        removeBtn.textContent = "제거";
        removeBtn.addEventListener("click", () => {
          recipeItems.splice(idx, 1);
          updateRecipeCount();
          renderRecipe();
          if (isPreviewOpen()) renderPreview();
        });

        actions.appendChild(removeBtn);

        row.appendChild(left);
        row.appendChild(actions);

        recipeDropZone.appendChild(row);
      });

      updateRecipeCount();
    }

    /***********************
     * 드래그&드롭: 레시피 영역
     ***********************/
    function wireDropZone(){
      recipeDropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        recipeDropZone.classList.add("droppable");
      });
      recipeDropZone.addEventListener("dragleave", () => {
        recipeDropZone.classList.remove("droppable");
      });
      recipeDropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        recipeDropZone.classList.remove("droppable");

        let payload;
        try { payload = JSON.parse(e.dataTransfer.getData("text/plain")); }
        catch { return; }
        if (!payload) return;

        if (payload.type === "add"){
          if (recipeItems.length >= MAX_RECIPE) return;
          if (!isAvailable(payload.name)) return;

          recipeItems.push({ name: payload.name, cat: payload.cat });
          updateRecipeCount();
          renderRecipe();
          if (isPreviewOpen()) renderPreview();
        }
      });
    }

    /***********************
     * 탭
     ***********************/
    function wireTabs(){
      tabs.addEventListener("click", (e) => {
        const t = e.target.closest(".tab");
        if (!t) return;
        currentTab = t.dataset.cat;

        [...tabs.querySelectorAll(".tab")].forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        renderItems();
      });
    }

    /***********************
     * 프리셋(미리보기): 햄버거 외형 렌더
     * - "이미지" 목적: 실제 이미지 파일 없이도 외형(스택 레이어)로 시각화
     * - 나중에 실제 PNG 에셋으로 바꿀 때: 여기 렌더 함수만 교체하면 됨
     ***********************/
    function catToClass(cat){
      if (cat === "고기") return "meat";
      if (cat === "채소") return "veg";
      if (cat === "향신료") return "spice";
      return "";
    }

    function renderPreview(){
      // 우측 정보
      previewBreadText.textContent = (selectedBread === "밀 빵") ? `${selectedBread} (∞)` : selectedBread;
      previewCountChip.textContent = `${recipeItems.length} / ${MAX_RECIPE}`;
      previewItemsText.textContent =
        recipeItems.length
          ? recipeItems.map((x,i)=>`${i+1}. ${x.name} (${x.cat})`).join("\n")
          : "재료 없음";

      // 햄버거 레이어(위→아래)
      burgerView.innerHTML = "";

      // 상단 빵
      const topBun = document.createElement("div");
      topBun.className = "layer bun-top bread";
      topBun.textContent = `${selectedBread} (상단)`;
      burgerView.appendChild(topBun);

      // 재료 레이어
      if (recipeItems.length === 0){
        const empty = document.createElement("div");
        empty.className = "layer";
        empty.style.background = "rgba(255,255,255,.04)";
        empty.textContent = "재료를 추가하면 외형이 쌓입니다";
        burgerView.appendChild(empty);
      } else {
        recipeItems.forEach((it) => {
          const layer = document.createElement("div");
          layer.className = `layer ${catToClass(it.cat)}`;
          layer.textContent = it.name;
          burgerView.appendChild(layer);
        });
      }

      // 하단 빵
      const botBun = document.createElement("div");
      botBun.className = "layer bun-bot bread";
      botBun.textContent = `${selectedBread} (하단)`;
      burgerView.appendChild(botBun);
    }

    /***********************
     * 버튼 동작
     ***********************/
    btnPlay.addEventListener("click", () => {
      const summary =
        `빵: ${selectedBread}\n` +
        `재료(${recipeItems.length}/${MAX_RECIPE}): ` +
        (recipeItems.length ? recipeItems.map(x=>x.name).join(", ") : "없음");
      alert("가게 운영 시작!\n\n" + summary);
    });

    // 프리셋 = 미리보기 팝업 오픈
    btnPreset.addEventListener("click", () => openPreview());
    btnPreviewExit.addEventListener("click", () => closePreview());

    btnExit.addEventListener("click", () => closeOverlay());

    /***********************
     * 빵 드롭다운
     ***********************/
    breadBtn.addEventListener("click", () => {
      breadDropdown.classList.toggle("open");
    });
    window.addEventListener("click", (e) => {
      if (!breadDropdown.contains(e.target)) breadDropdown.classList.remove("open");
    });

    /***********************
     * 홈: 가게 운영 시작만 상호작용
     ***********************/
    btnStart.addEventListener('click', openOverlay);

    // 오버레이 바깥 클릭 시 닫기
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeOverlay();
    });

    // 미리보기 바깥 클릭은 닫지 않음(원하면 추가 가능)
    previewOverlay.addEventListener("click", (e) => {
      if (e.target === previewOverlay) {
        // 바깥 클릭 닫기 비활성: 기획서에 '나가기 버튼' 명시
      }
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape"){
        // ESC: 우선순위(미리보기 > 운영팝업)
        if (isPreviewOpen()) closePreview();
        else if (overlay.classList.contains("is-open")) closeOverlay();
      }
    });

    /***********************
     * 탭/렌더 초기화
     ***********************/
    function setBreadInit(bread){
      selectedBread = bread;
      selectedBreadChip.textContent = `빵: ${selectedBread}`;
      breadBtnValue.textContent = selectedBread;
    }

    function renderAll(){
      renderBreadMenu();
      renderItems();
      renderRecipe();
      if (isPreviewOpen()) renderPreview();
    }

    function init(){
      setBreadInit("밀 빵");
      wireDropZone();
      wireTabs();
      renderAll();
    }
    init();

    // 드래그로 재료 추가 후 실시간 반영을 위해 setBread에서 renderPreview 호출 포함
    // 레시피 제거 버튼에서도 renderPreview 호출 포함
  </script>
</body>
</html>
