<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>가게 프로토타입</title>
  <style>
    /*******************************
     * Stardew-like Warm UI Palette
     *******************************/
    :root{
      --bg:#3b2a1d;
      --bg2:#2c1f16;

      --panel:#e7d2aa;
      --panel2:#d8bd8a;
      --panel3:#caa56f;

      --line: rgba(66,44,26,.35);
      --line2: rgba(66,44,26,.55);

      --text:#2a1c12;
      --muted:#5a3f2a;

      --accent:#2f8f4e;
      --accent2:#1f6f3b;

      --danger:#b23b3b;

      --shadow: 0 10px 22px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{
      box-sizing:border-box;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 25% 15%, rgba(255,219,150,.18), transparent 60%),
        radial-gradient(800px 500px at 70% 80%, rgba(255,236,195,.12), transparent 65%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    /* 홈 */
    .screen{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
      position:relative;
    }
    .center-actions{
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
      justify-content:center;
      width:min(520px, 92vw);
      padding:28px;
      background: linear-gradient(180deg, rgba(231,210,170,.96), rgba(216,189,138,.96));
      border:1px solid var(--line2);
      border-radius: calc(var(--radius) + 8px);
      box-shadow: var(--shadow);
    }
    .title{
      font-size:20px;
      font-weight:900;
      letter-spacing:-0.02em;
      margin:0 0 6px 0;
    }
    .subtitle{
      margin:0 0 12px 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
      text-align:center;
    }

    /* 버튼 */
    .btn{
      width:100%;
      border:0;
      border-radius:14px;
      padding:14px 16px;
      font-size:15px;
      font-weight:900;
      color:var(--text);
      background: linear-gradient(180deg, rgba(255,243,220,.95), rgba(232,206,160,.95));
      border:1px solid var(--line2);
      cursor:pointer;
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
      box-shadow: 0 4px 0 rgba(66,44,26,.25);
    }
    .btn:active{
      transform: translateY(1px);
      box-shadow: 0 3px 0 rgba(66,44,26,.22);
    }
    .btn-primary{
      background: linear-gradient(180deg, rgba(74,195,108,.95), rgba(47,143,78,.95));
      border:1px solid rgba(31,111,59,.55);
      color:#0e2416;
      box-shadow: 0 4px 0 rgba(31,111,59,.28);
    }
    .btn-disabled{
      opacity:.55;
      cursor:not-allowed;
      pointer-events:none;
      filter:saturate(.75);
      box-shadow:none;
    }

    .bottom-left{
      position:absolute;
      left:24px;
      bottom:24px;
      display:flex;
      flex-direction:column;
      gap:10px;
      width:min(220px, 44vw);
    }
    .bottom-right{
      position:absolute;
      right:24px;
      bottom:24px;
      width:min(220px, 44vw);
      display:flex;
      justify-content:flex-end;
    }
    @media (max-width: 520px){
      .bottom-left{ left:16px; bottom:16px; width:44vw; }
      .bottom-right{ right:16px; bottom:16px; width:44vw; }
      .center-actions{ padding:22px; }
    }

    /* 오버레이/모달 */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(28,18,12,.58);
      padding:24px;
      z-index:50;
    }
    .overlay.is-open{ display:grid; }

    .modal{
      width:min(980px, 96vw);
      background: linear-gradient(180deg, rgba(231,210,170,.98), rgba(216,189,138,.98));
      border:2px solid rgba(66,44,26,.55);
      border-radius: calc(var(--radius) + 12px);
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
    }

    /* 재료 세팅 UI 레이아웃 */
    .setup-wrap{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .setup-wrap{ grid-template-columns: 1fr; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,246,229,.96), rgba(232,206,160,.96));
      border:2px solid rgba(66,44,26,.45);
      border-radius: 18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      min-height:520px;
      min-width:0;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.55);
    }
    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .panel-title{
      font-weight:900;
      letter-spacing:-0.02em;
      font-size:15px;
      margin:0;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
      margin:0;
    }

    /* "레시피" 버튼 (우측 상단) */
    .recipe-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      border:2px solid rgba(66,44,26,.30);
      background: rgba(255,255,255,.28);
      padding:8px 12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 3px 0 rgba(66,44,26,.16);
      color: var(--text);
      white-space:nowrap;
    }
    .recipe-btn:active{
      transform: translateY(1px);
      box-shadow: 0 2px 0 rgba(66,44,26,.14);
    }
    .recipe-btn .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(47,143,78,.95);
      border:1px solid rgba(31,111,59,.55);
      box-shadow: 0 1px 0 rgba(255,255,255,.35) inset;
    }

    /* 좌측: 레시피 */
    .bread-row{
      display:flex;
      gap:10px;
      align-items:stretch;
      margin-bottom:10px;
    }
    .bread-btn{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border:2px solid rgba(66,44,26,.45);
      background: linear-gradient(180deg, rgba(255,243,220,.95), rgba(232,206,160,.95));
      cursor:pointer;
      user-select:none;
      font-weight:900;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:2px solid rgba(66,44,26,.35);
      background: rgba(255,255,255,.35);
      color:var(--muted);
      white-space:nowrap;
    }

    .dropdown{ position:relative; flex:1; min-width:0; }
    .dropdown-menu{
      position:absolute;
      left:0; right:0;
      top:calc(100% + 8px);
      background: linear-gradient(180deg, rgba(255,246,229,.98), rgba(232,206,160,.98));
      border:2px solid rgba(66,44,26,.5);
      border-radius:14px;
      overflow:hidden;
      box-shadow: var(--shadow);
      display:none;
      z-index:60;
      max-height:240px;
      overflow:auto;
    }
    .dropdown.open .dropdown-menu{ display:block; }
    .dd-item{
      padding:10px 12px;
      border-bottom:1px solid rgba(66,44,26,.18);
      cursor:pointer;
      font-weight:900;
    }
    .dd-item:last-child{ border-bottom:0; }
    .dd-item:hover{ background: rgba(255,255,255,.35); }

    .recipe-box{
      border:2px dashed rgba(66,44,26,.35);
      border-radius:16px;
      padding:10px;
      flex:1;
      min-height:320px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
      background: rgba(255,255,255,.20);
    }
    .recipe-slot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:2px solid rgba(66,44,26,.25);
      background: rgba(255,255,255,.35);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.55);
    }
    .slot-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .slot-idx{
      width:22px;
      height:22px;
      border-radius:999px;
      display:grid;
      place-items:center;
      font-size:12px;
      font-weight:900;
      color:#0e2416;
      background: linear-gradient(180deg, rgba(74,195,108,.95), rgba(47,143,78,.95));
      border:1px solid rgba(31,111,59,.55);
      flex:0 0 auto;
    }
    .slot-name{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .slot-cat{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .slot-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .mini-btn{
      border:2px solid rgba(66,44,26,.30);
      background: rgba(255,255,255,.35);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 3px 0 rgba(66,44,26,.18);
    }
    .mini-btn:active{ transform: translateY(1px); box-shadow: 0 2px 0 rgba(66,44,26,.16); }
    .mini-btn.danger{
      border-color: rgba(178,59,59,.45);
      background: rgba(178,59,59,.18);
      color:#3a1414;
      box-shadow: 0 3px 0 rgba(178,59,59,.18);
    }
    .drop-hint{
      margin-top:auto;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* 우측: 분류 탭 + 재료 리스트 */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      padding:8px 12px;
      border-radius:999px;
      border:2px solid rgba(66,44,26,.30);
      background: rgba(255,255,255,.28);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      user-select:none;
      box-shadow: 0 3px 0 rgba(66,44,26,.16);
    }
    .tab:active{ transform: translateY(1px); box-shadow: 0 2px 0 rgba(66,44,26,.14); }
    .tab.active{
      background: rgba(74,195,108,.22);
      border-color: rgba(31,111,59,.45);
      color:#0e2416;
      box-shadow: 0 3px 0 rgba(31,111,59,.18);
    }

    .items{
      border:2px solid rgba(66,44,26,.30);
      border-radius:16px;
      background: rgba(255,255,255,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }
    .items-scroll{
      overflow:auto;
      padding:10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 900px){
      .items-scroll{ grid-template-columns: 1fr; }
    }
    .item{
      border:2px solid rgba(66,44,26,.26);
      background: rgba(255,255,255,.30);
      border-radius:14px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:grab;
      user-select:none;
      min-width:0;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.55);
    }
    .item:active{ cursor:grabbing; }
    .item.disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.75);
    }
    .item-left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .item-name{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item-sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .count{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:2px solid rgba(66,44,26,.26);
      background: rgba(255,255,255,.25);
      flex:0 0 auto;
      color:var(--muted);
    }

    /* 하단 버튼바 (프리셋 버튼 제거: 2개로 변경) */
    .modal-footer{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btn-flat{
      width:100%;
      border-radius:16px;
      padding:14px 16px;
      font-size:15px;
      font-weight:900;
      border:2px solid rgba(66,44,26,.35);
      background: rgba(255,255,255,.28);
      color: var(--text);
      cursor:pointer;
      box-shadow: 0 4px 0 rgba(66,44,26,.18);
    }
    .btn-flat:active{ transform: translateY(1px); box-shadow: 0 3px 0 rgba(66,44,26,.16); }
    .btn-flat.primary{
      background: rgba(74,195,108,.22);
      border-color: rgba(31,111,59,.45);
      color:#0e2416;
      box-shadow: 0 4px 0 rgba(31,111,59,.18);
    }
    .btn-flat.danger{
      background: rgba(178,59,59,.18);
      border-color: rgba(178,59,59,.42);
      color:#3a1414;
      box-shadow: 0 4px 0 rgba(178,59,59,.18);
    }

    .droppable{
      outline: 3px solid rgba(74,195,108,.45);
      outline-offset: 2px;
    }

    /***********************
     * 미리보기(기존 프리셋 기능)
     ***********************/
    .preview-overlay{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(28,18,12,.68);
      padding:24px;
      z-index:80;
    }
    .preview-overlay.is-open{ display:grid; }

    .preview-modal{
      width:min(720px, 96vw);
      border-radius: calc(var(--radius) + 12px);
      border:2px solid rgba(66,44,26,.55);
      background: linear-gradient(180deg, rgba(231,210,170,.98), rgba(216,189,138,.98));
      box-shadow: var(--shadow);
      padding:16px;
    }
    .preview-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .preview-title{
      font-weight:900;
      letter-spacing:-0.02em;
      font-size:15px;
      margin:0;
    }
    .preview-sub{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }
    .preview-grid{
      display:grid;
      grid-template-columns: 1fr 260px;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 720px){
      .preview-grid{ grid-template-columns: 1fr; }
    }
    .burger-stage{
      border:2px solid rgba(66,44,26,.30);
      border-radius:18px;
      background: rgba(255,255,255,.20);
      padding:14px;
      min-height:420px;
      display:grid;
      place-items:center;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.55);
    }
    .burger{
      width:min(360px, 90%);
      display:flex;
      flex-direction:column;
      align-items:stretch;
      gap:6px;
      padding:10px;
    }
    .layer{
      height:34px;
      border-radius: 16px;
      border:2px solid rgba(66,44,26,.20);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
      letter-spacing:-0.01em;
      user-select:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:0 10px;
      background: rgba(255,255,255,.28);
    }
    .layer.bun-top{ height:46px; border-radius: 24px 24px 16px 16px; }
    .layer.bun-bot{ height:42px; border-radius: 16px 16px 24px 24px; }

    .layer.meat{ background: rgba(178,59,59,.18); }
    .layer.veg{ background: rgba(47,143,78,.18); }
    .layer.spice{ background: rgba(160,110,60,.18); }
    .layer.bread{ background: rgba(202,165,111,.35); }

    .preview-side{
      border:2px solid rgba(66,44,26,.30);
      border-radius:18px;
      background: rgba(255,255,255,.18);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:420px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.55);
    }
    .meta-box{
      border:2px solid rgba(66,44,26,.20);
      background: rgba(255,255,255,.25);
      border-radius:14px;
      padding:10px;
    }
    .meta-title{
      font-weight:900;
      font-size:12px;
      margin:0 0 6px 0;
      color: rgba(42,28,18,.95);
    }
    .meta-text{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .preview-actions{
      margin-top:auto;
      display:flex;
      gap:10px;
    }
    .preview-actions .btn-flat{ padding:12px 14px; }
  </style>
</head>
<body>
  <!-- 홈 화면 -->
  <main class="screen" id="home">
    <section class="center-actions" aria-label="홈 메뉴">
      <h1 class="title">가게 운영</h1>
      <p class="subtitle">현재 상호작용은 ‘가게 운영 시작’만 가능합니다.</p>
      <button class="btn btn-primary" id="btnStart">가게 운영 시작</button>
    </section>

    <div class="bottom-left" aria-label="좌측 하단 메뉴">
      <button class="btn btn-disabled" aria-disabled="true">가게 연구</button>
      <button class="btn btn-disabled" aria-disabled="true">창고</button>
    </div>

    <div class="bottom-right" aria-label="우측 하단 메뉴">
      <button class="btn btn-disabled" aria-disabled="true">나가기</button>
    </div>
  </main>

  <!-- 가게 운영 시작(재료 세팅) 팝업 -->
  <div class="overlay" id="opStartOverlay" role="dialog" aria-modal="true" aria-labelledby="opStartTitle">
    <div class="modal">
      <div class="panel-header" style="margin-bottom:12px;">
        <div>
          <div class="panel-title" id="opStartTitle">햄버거 재료 세팅</div>
          <p class="hint">우측 재료를 드래그해서 레시피에 넣을 수 있습니다. (최대 10개)</p>
        </div>
        <div class="chip" id="recipeCountChip">0 / 10</div>
      </div>

      <div class="setup-wrap" id="setupView">
        <!-- 좌측: 레시피 -->
        <section class="panel" aria-label="레시피">
          <div class="panel-header">
            <h3 class="panel-title">레시피</h3>
            <span class="chip" id="selectedBreadChip">빵: 밀 빵</span>
          </div>

          <div class="bread-row">
            <div class="dropdown" id="breadDropdown">
              <div class="bread-btn" id="breadBtn" role="button" tabindex="0" aria-label="빵 선택">
                <span>빵 선택</span>
                <span class="chip" id="breadBtnValue">밀 빵</span>
              </div>
              <div class="dropdown-menu" id="breadMenu" aria-label="빵 목록"></div>
            </div>
          </div>

          <div class="recipe-box" id="recipeDropZone" aria-label="레시피 재료 칸 (드롭 가능)"></div>

          <p class="drop-hint">
            • 우측 재료를 드래그하여 추가<br/>
            • 추가된 재료는 제거 버튼으로 다시 뺄 수 있음
          </p>
        </section>

        <!-- 우측: 재료 (우측 상단에 레시피 버튼 배치) -->
        <section class="panel" aria-label="재료 목록">
          <div class="panel-header">
            <div>
              <h3 class="panel-title">재료</h3>
              <p class="hint">보유 수량이 0개인 재료는 비활성 처리됩니다.</p>
            </div>

            <!-- 레시피 버튼: 프리셋 기능(미리보기)으로 연결 -->
            <button class="recipe-btn" id="btnRecipePreview" type="button" aria-label="레시피 미리보기">
              <span class="dot" aria-hidden="true"></span>
              레시피
            </button>
          </div>

          <div class="tabs" id="tabs">
            <div class="tab active" data-cat="고기">고기</div>
            <div class="tab" data-cat="채소">채소</div>
            <div class="tab" data-cat="향신료">향신료</div>
          </div>

          <div class="items">
            <div class="items-scroll" id="itemsGrid" aria-label="재료 스크롤 리스트"></div>
          </div>
        </section>
      </div>

      <!-- 하단 버튼: 프리셋 제거 -->
      <div class="modal-footer" aria-label="하단 버튼">
        <button class="btn-flat primary" id="btnPlay">시작</button>
        <button class="btn-flat danger" id="btnExit">나가기</button>
      </div>
    </div>
  </div>

  <!-- 미리보기(기존 프리셋 기능) 팝업 -->
  <div class="preview-overlay" id="previewOverlay" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="preview-modal">
      <div class="preview-head">
        <div>
          <div class="preview-title" id="previewTitle">레시피 미리보기 (햄버거 외형)</div>
          <p class="preview-sub">재료/빵을 변경하면 이 화면의 외형도 즉시 반영됩니다.</p>
        </div>
        <div class="chip" id="previewCountChip">0 / 10</div>
      </div>

      <div class="preview-grid">
        <div class="burger-stage" aria-label="햄버거 이미지 영역">
          <div class="burger" id="burgerView"></div>
        </div>

        <aside class="preview-side" aria-label="미리보기 정보">
          <div class="meta-box">
            <p class="meta-title">선택 빵</p>
            <p class="meta-text" id="previewBreadText">-</p>
          </div>
          <div class="meta-box">
            <p class="meta-title">재료 순서</p>
            <p class="meta-text" id="previewItemsText">-</p>
          </div>
          <div class="meta-box">
            <p class="meta-title">목적</p>
            <p class="meta-text">영업 중 판매될 햄버거가 어떻게 보이는지 시각적으로 확인</p>
          </div>

          <div class="preview-actions">
            <button class="btn-flat danger" id="btnPreviewExit">나가기</button>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    const BREADS = ["밀 빵","브리오슈","치아바타","베이글","머핀"];

    const INGREDIENTS = [
      { name:"콩고기", cat:"고기", infinite:true },
      { name:"돼지고기", cat:"고기" },
      { name:"소고기", cat:"고기" },
      { name:"닭고기", cat:"고기" },
      { name:"물고기", cat:"고기" },

      { name:"토마토", cat:"채소" },
      { name:"양상추", cat:"채소" },
      { name:"감자", cat:"채소" },
      { name:"당근", cat:"채소" },
      { name:"상추", cat:"채소" },
      { name:"파프리카", cat:"채소" },
      { name:"가지", cat:"채소" },
      { name:"브로콜리", cat:"채소" },
      { name:"콜리플라워", cat:"채소" },
      { name:"청경채", cat:"채소" },
      { name:"아티초크", cat:"채소" },
      { name:"블루베리", cat:"채소" },
      { name:"호박", cat:"채소" },

      { name:"마늘", cat:"향신료" },
      { name:"고추", cat:"향신료" },
      { name:"깻잎", cat:"향신료" },
      { name:"로즈마리", cat:"향신료" },
      { name:"바질", cat:"향신료" },
      { name:"박하", cat:"향신료" },
      { name:"샬롯", cat:"향신료" },
      { name:"캐모마일", cat:"향신료" },
    ];

    const STOCK = {
      "콩고기": Infinity,
      "돼지고기": 3,
      "소고기": 2,
      "닭고기": 0,
      "물고기": 1,

      "토마토": 5,
      "양상추": 0,
      "감자": 4,
      "당근": 2,
      "상추": 1,
      "파프리카": 0,
      "가지": 2,
      "브로콜리": 1,
      "콜리플라워": 0,
      "청경채": 1,
      "아티초크": 0,
      "블루베리": 2,
      "호박": 3,

      "마늘": 6,
      "고추": 2,
      "깻잎": 1,
      "로즈마리": 0,
      "바질": 2,
      "박하": 0,
      "샬롯": 1,
      "캐모마일": 0,
    };

    const MAX_RECIPE = 10;
    let selectedBread = "밀 빵";
    let currentTab = "고기";
    let recipeItems = [];

    const btnStart = document.getElementById('btnStart');
    const overlay = document.getElementById('opStartOverlay');

    const recipeDropZone = document.getElementById('recipeDropZone');
    const recipeCountChip = document.getElementById('recipeCountChip');

    const selectedBreadChip = document.getElementById('selectedBreadChip');
    const breadDropdown = document.getElementById('breadDropdown');
    const breadBtn = document.getElementById('breadBtn');
    const breadBtnValue = document.getElementById('breadBtnValue');
    const breadMenu = document.getElementById('breadMenu');

    const tabs = document.getElementById('tabs');
    const itemsGrid = document.getElementById('itemsGrid');

    const btnPlay = document.getElementById('btnPlay');
    const btnExit = document.getElementById('btnExit');

    // 새로 추가: 우측 상단 "레시피" 버튼(미리보기)
    const btnRecipePreview = document.getElementById('btnRecipePreview');

    const previewOverlay = document.getElementById('previewOverlay');
    const btnPreviewExit = document.getElementById('btnPreviewExit');
    const burgerView = document.getElementById('burgerView');
    const previewBreadText = document.getElementById('previewBreadText');
    const previewItemsText = document.getElementById('previewItemsText');
    const previewCountChip = document.getElementById('previewCountChip');

    function openOverlay(){
      overlay.classList.add('is-open');
      breadDropdown.classList.remove('open');
      renderAll();
    }
    function closeOverlay(){
      overlay.classList.remove('is-open');
      breadDropdown.classList.remove('open');
      closePreview();
      recipeDropZone.classList.remove('droppable');
    }

    function openPreview(){
      previewOverlay.classList.add('is-open');
      renderPreview();
    }
    function closePreview(){
      previewOverlay.classList.remove('is-open');
    }
    function isPreviewOpen(){
      return previewOverlay.classList.contains('is-open');
    }

    function setBread(bread){
      selectedBread = bread;
      selectedBreadChip.textContent = `빵: ${selectedBread}`;
      breadBtnValue.textContent = selectedBread;
      if (isPreviewOpen()) renderPreview();
    }

    function getCountLabel(name){
      const v = STOCK[name];
      if (v === Infinity) return "∞";
      return String(v ?? 0);
    }
    function isAvailable(name){
      const v = STOCK[name];
      return v === Infinity || (typeof v === "number" && v > 0);
    }
    function updateRecipeCount(){
      recipeCountChip.textContent = `${recipeItems.length} / ${MAX_RECIPE}`;
    }

    function renderBreadMenu(){
      breadMenu.innerHTML = "";
      BREADS.forEach(b => {
        const div = document.createElement("div");
        div.className = "dd-item";
        const label = (b === "밀 빵") ? `${b}  (∞)` : b;
        div.textContent = label;
        div.addEventListener("click", () => {
          setBread(b);
          breadDropdown.classList.remove("open");
        });
        breadMenu.appendChild(div);
      });
    }

    function renderItems(){
      itemsGrid.innerHTML = "";
      const list = INGREDIENTS.filter(x => x.cat === currentTab);

      list.forEach(x => {
        const card = document.createElement("div");
        const available = isAvailable(x.name);

        card.className = "item" + (available ? "" : " disabled");
        card.setAttribute("draggable", available ? "true" : "false");
        card.dataset.name = x.name;
        card.dataset.cat = x.cat;

        const left = document.createElement("div");
        left.className = "item-left";

        const name = document.createElement("div");
        name.className = "item-name";
        name.textContent = x.name;

        const sub = document.createElement("div");
        sub.className = "item-sub";
        sub.textContent = `${x.cat} · 보유 ${getCountLabel(x.name)}`;

        left.appendChild(name);
        left.appendChild(sub);

        const count = document.createElement("div");
        count.className = "count";
        count.textContent = getCountLabel(x.name);

        card.appendChild(left);
        card.appendChild(count);

        if (available){
          card.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", JSON.stringify({
              type: "add",
              name: x.name,
              cat: x.cat
            }));
          });
        }

        itemsGrid.appendChild(card);
      });
    }

    function renderRecipe(){
      recipeDropZone.innerHTML = "";

      if (recipeItems.length === 0){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.style.padding = "8px 2px";
        empty.textContent = "레시피 재료가 비어있습니다. 우측 재료를 드래그해서 넣어주세요.";
        recipeDropZone.appendChild(empty);
      }

      recipeItems.forEach((it, idx) => {
        const row = document.createElement("div");
        row.className = "recipe-slot";

        const left = document.createElement("div");
        left.className = "slot-left";

        const badge = document.createElement("div");
        badge.className = "slot-idx";
        badge.textContent = String(idx + 1);

        const name = document.createElement("div");
        name.className = "slot-name";
        name.textContent = it.name;

        const cat = document.createElement("div");
        cat.className = "slot-cat";
        cat.textContent = it.cat;

        left.appendChild(badge);
        left.appendChild(name);
        left.appendChild(cat);

        const actions = document.createElement("div");
        actions.className = "slot-actions";

        const removeBtn = document.createElement("button");
        removeBtn.className = "mini-btn danger";
        removeBtn.textContent = "제거";
        removeBtn.addEventListener("click", () => {
          recipeItems.splice(idx, 1);
          updateRecipeCount();
          renderRecipe();
          if (isPreviewOpen()) renderPreview();
        });

        actions.appendChild(removeBtn);

        row.appendChild(left);
        row.appendChild(actions);

        recipeDropZone.appendChild(row);
      });

      updateRecipeCount();
    }

    function wireDropZone(){
      recipeDropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        recipeDropZone.classList.add("droppable");
      });
      recipeDropZone.addEventListener("dragleave", () => {
        recipeDropZone.classList.remove("droppable");
      });
      recipeDropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        recipeDropZone.classList.remove("droppable");

        let payload;
        try { payload = JSON.parse(e.dataTransfer.getData("text/plain")); }
        catch { return; }
        if (!payload) return;

        if (payload.type === "add"){
          if (recipeItems.length >= MAX_RECIPE) return;
          if (!isAvailable(payload.name)) return;

          recipeItems.push({ name: payload.name, cat: payload.cat });
          updateRecipeCount();
          renderRecipe();
          if (isPreviewOpen()) renderPreview();
        }
      });
    }

    function wireTabs(){
      tabs.addEventListener("click", (e) => {
        const t = e.target.closest(".tab");
        if (!t) return;
        currentTab = t.dataset.cat;

        [...tabs.querySelectorAll(".tab")].forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        renderItems();
      });
    }

    function catToClass(cat){
      if (cat === "고기") return "meat";
      if (cat === "채소") return "veg";
      if (cat === "향신료") return "spice";
      return "";
    }

    function renderPreview(){
      previewBreadText.textContent = (selectedBread === "밀 빵") ? `${selectedBread} (∞)` : selectedBread;
      previewCountChip.textContent = `${recipeItems.length} / ${MAX_RECIPE}`;
      previewItemsText.textContent =
        recipeItems.length
          ? recipeItems.map((x,i)=>`${i+1}. ${x.name} (${x.cat})`).join("\n")
          : "재료 없음";

      burgerView.innerHTML = "";

      const topBun = document.createElement("div");
      topBun.className = "layer bun-top bread";
      topBun.textContent = `${selectedBread} (상단)`;
      burgerView.appendChild(topBun);

      if (recipeItems.length === 0){
        const empty = document.createElement("div");
        empty.className = "layer";
        empty.textContent = "재료를 추가하면 외형이 쌓입니다";
        burgerView.appendChild(empty);
      } else {
        recipeItems.forEach((it) => {
          const layer = document.createElement("div");
          layer.className = `layer ${catToClass(it.cat)}`;
          layer.textContent = it.name;
          burgerView.appendChild(layer);
        });
      }

      const botBun = document.createElement("div");
      botBun.className = "layer bun-bot bread";
      botBun.textContent = `${selectedBread} (하단)`;
      burgerView.appendChild(botBun);
    }

    btnPlay.addEventListener("click", () => {
      const summary =
        `빵: ${selectedBread}\n` +
        `재료(${recipeItems.length}/${MAX_RECIPE}): ` +
        (recipeItems.length ? recipeItems.map(x=>x.name).join(", ") : "없음");
      alert("가게 운영 시작!\n\n" + summary);
    });

    // 변경 핵심: "레시피" 버튼 -> 미리보기 오픈
    btnRecipePreview.addEventListener("click", () => openPreview());

    btnPreviewExit.addEventListener("click", () => closePreview());
    btnExit.addEventListener("click", () => closeOverlay());

    breadBtn.addEventListener("click", () => {
      breadDropdown.classList.toggle("open");
    });
    window.addEventListener("click", (e) => {
      if (!breadDropdown.contains(e.target)) breadDropdown.classList.remove("open");
    });

    btnStart.addEventListener('click', openOverlay);

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeOverlay();
    });

    previewOverlay.addEventListener("click", (e) => {
      if (e.target === previewOverlay) {
        // 바깥 클릭 닫기 비활성(나가기 버튼으로만)
      }
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape"){
        if (isPreviewOpen()) closePreview();
        else if (overlay.classList.contains("is-open")) closeOverlay();
      }
    });

    function setBreadInit(bread){
      selectedBread = bread;
      selectedBreadChip.textContent = `빵: ${selectedBread}`;
      breadBtnValue.textContent = selectedBread;
    }

    function renderAll(){
      renderBreadMenu();
      renderItems();
      renderRecipe();
      if (isPreviewOpen()) renderPreview();
    }

    function init(){
      setBreadInit("밀 빵");
      wireDropZone();
      wireTabs();
      renderAll();
    }
    init();
  </script>
</body>
</html>
